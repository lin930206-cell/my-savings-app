<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>100å¤©å­˜éŒ¢è¨ˆç•«</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F5EBE0">

    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg: #F5EBE0; --dark: #D5BDAF; --text: #7A6B5D; }
        body { font-family: 'ZCOOL KuaiLe', 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        .safe-area { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); height: 100vh; display: flex; flex-direction: column; }
        .content { flex: 1; overflow-y: auto; padding: 24px; -webkit-overflow-scrolling: touch; }
        .card { background: white; border-radius: 28px; box-shadow: 0 8px 20px rgba(122, 107, 93, 0.06); }
        .grid-item { aspect-ratio: 1/1; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; font-size: 1.1rem; font-weight: 700; }
        .lit { background: var(--dark); color: white; transform: scale(0.95); }
        .unlit { background: white; color: var(--text); }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 0; }
        
        /* è¼‰å…¥å‹•ç•« */
        .dot { width: 8px; height: 8px; background: var(--dark); border-radius: 50%; animation: b 1.4s infinite both; }
        @keyframes b { 0%, 80%, 100% { transform: scale(0.3); opacity: 0.3; } 40% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div class="safe-area">
    <div id="loader" class="flex flex-col items-center justify-center h-full">
        <div class="flex gap-2 mb-4"><div class="dot" style="animation-delay:-0.32s"></div><div class="dot" style="animation-delay:-0.16s"></div><div class="dot"></div></div>
        <h2 class="text-xl font-bold">100å¤©å­˜éŒ¢è¨ˆç•«...</h2>
    </div>

    <div id="home" class="hidden content">
        <div class="text-center mt-10 mb-12"><div class="text-5xl mb-4">âœ¨</div><h1 class="text-3xl font-bold">100å¤©å­˜éŒ¢è¨ˆç•«</h1><p class="mt-2 text-[#A79277] opacity-80">å°å°çš„ç´¯ç©ï¼Œå¤§å¤§çš„é©šå–œ</p></div>
        <div class="grid gap-4">
            <button onclick="newPlan(1000)" class="card p-6 flex justify-between items-center font-bold">100å¤©å­˜ 1000 ğŸ§¸</button>
            <button onclick="newPlan(2000)" class="card p-6 flex justify-between items-center font-bold">100å¤©å­˜ 2000 ğŸ°</button>
            <button onclick="newPlan(5000)" class="card p-6 flex justify-between items-center font-bold">100å¤©å­˜ 5000 ğŸ¥¨</button>
            <button onclick="newPlan(10000)" class="card p-6 flex justify-between items-center font-bold">100å¤©å­˜ 10000 ğŸ¥‚</button>
        </div>
    </div>

    <div id="detail" class="hidden content">
        <div class="flex items-center justify-between mb-6"><button onclick="view('home')" class="w-10 h-10 card flex items-center justify-center text-xl">â†</button><h2 id="pt" class="font-bold"></h2><div class="w-10"></div></div>
        <div class="card p-8 mb-6 text-center">
            <p class="text-xs text-[#A79277] mb-1">å·²å„²è“„é‡‘é¡</p>
            <h3 id="ts" class="text-5xl font-black mb-4">$0</h3>
            <div class="w-full bg-[#F5EBE0] h-3 rounded-full overflow-hidden"><div id="pb" class="bg-[#D5BDAF] h-full transition-all duration-1000" style="width: 0%"></div></div>
            <p id="pct" class="text-xs font-bold mt-2 text-[#D5BDAF]">0% å®Œæˆ</p>
        </div>
        <div id="grid" class="grid grid-cols-4 gap-3 pb-10"></div>
        <button onclick="reset()" class="w-full py-6 text-[#A79277] text-sm underline opacity-30">é‡è¨­é€²åº¦</button>
    </div>
</div>

<script>
    const cfg = JSON.parse(__firebase_config);
    firebase.initializeApp(cfg);
    const db = firebase.firestore(), auth = firebase.auth();
    const aid = typeof __app_id !== 'undefined' ? __app_id : 'save-v100-hybrid';
    
    let user = null, plan = null;

    // --- æ ¸å¿ƒé‚è¼¯ï¼šæœ¬åœ°å„ªå…ˆ ---
    function loadLocal() {
        const localData = localStorage.getItem('savings_plan');
        if (localData) {
            plan = JSON.parse(localData);
            render();
            view('detail');
            return true;
        }
        return false;
    }

    function saveLocal(data) {
        localStorage.setItem('savings_plan', JSON.stringify(data));
        // å˜—è©¦åŒæ­¥åˆ°é›²ç«¯ (èƒŒæ™¯åŸ·è¡Œ)
        if (user) {
            db.collection('artifacts').doc(aid).collection('users').doc(user.uid).collection('data').doc('plan').set(data).catch(() => {});
        }
    }

    // åˆå§‹åŒ–
    window.onload = () => {
        const hasLocal = loadLocal();
        
        auth.onAuthStateChanged(async (u) => {
            user = u || (await auth.signInAnonymously()).user;
            
            // å˜—è©¦å¾é›²ç«¯æŠ“å– (åªåœ¨æ²’æœ‰æœ¬åœ°è³‡æ–™æˆ–éœ€è¦æ›´æ–°æ™‚)
            db.collection('artifacts').doc(aid).collection('users').doc(user.uid).collection('data').doc('plan').get().then(doc => {
                if (doc.exists) {
                    const cloudData = doc.data();
                    // å¦‚æœé›²ç«¯æœ‰è³‡æ–™ä¸”è·Ÿæœ¬åœ°ä¸åŒï¼Œä»¥é›²ç«¯ç‚ºä¸»ï¼ˆæˆ–æ˜¯ä½ å¯ä»¥åšæ›´è¤‡é›œçš„åˆ¤æ–·ï¼‰
                    if (!plan || JSON.stringify(cloudData) !== JSON.stringify(plan)) {
                        plan = cloudData;
                        localStorage.setItem('savings_plan', JSON.stringify(plan));
                        render();
                        view('detail');
                    }
                }
                document.getElementById('loader').classList.add('hidden');
                if (!plan && !hasLocal) view('home');
            }).catch(() => {
                document.getElementById('loader').classList.add('hidden');
                if (!plan && !hasLocal) view('home');
            });
        });
    };

    function newPlan(target) {
        let r = target, a = [];
        for (let i = 0; i < 99; i++) {
            const v = Math.floor(Math.random() * ((Math.min(200, r - (99 - i) * 5) - 5) / 5 + 1)) * 5 + 5;
            a.push(v); r -= v;
        }
        a.push(r); a.sort(() => Math.random() - 0.5);
        plan = { target, amounts: a, progress: new Array(100).fill(false) };
        saveLocal(plan);
        render();
        view('detail');
    }

    function render() {
        if (!plan) return;
        document.getElementById('pt').innerText = `100å¤©å­˜ ${plan.target} å…ƒ`;
        const g = document.getElementById('grid'); g.innerHTML = '';
        let tot = 0, count = 0;
        
        plan.amounts.forEach((n, i) => {
            const done = plan.progress[i];
            if (done) { tot += n; count++; }
            const d = document.createElement('div');
            d.className = `grid-item ${done ? 'lit' : 'unlit'}`;
            d.innerHTML = `<span class="text-[8px] mb-0.5 opacity-40">D${i+1}</span>${n}`;
            d.onclick = () => { plan.progress[i] = !plan.progress[i]; render(); saveLocal(plan); };
            g.appendChild(d);
        });
        document.getElementById('ts').innerText = `$${tot}`;
        document.getElementById('pct').innerText = `${count}% å®Œæˆ`;
        setTimeout(() => document.getElementById('pb').style.width = `${count}%`, 50);
    }

    function view(id) {
        document.getElementById('home').classList.add('hidden');
        document.getElementById('detail').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
    }

    function reset() {
        if (confirm("è¦é‡è¨­é€²åº¦å—ï¼Ÿ")) {
            localStorage.removeItem('savings_plan');
            if (user) db.collection('artifacts').doc(aid).collection('users').doc(user.uid).collection('data').doc('plan').delete();
            plan = null;
            view('home');
        }
    }
</script>

</body>
</html>

